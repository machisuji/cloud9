<a:application xmlns:a="http://ajax.org/2005/aml">
    <a:script><![CDATA[
        function filesort(value, args, xmlNode) {
            return (xmlNode.tagName == "folder" ? 0 : 1) + value.toLowerCase();
        }

        function createPath(a, b){
            return b + "/" + apf.getFilename(a);
        }
    ]]></a:script>
    <a:window id="winDiffView"
      flex     = "1"
      skin     = "fm-window"
      title    = "gitc"
      modal    = "false"
      buttons  = "close"
      minwidth = "130"
      optimize = "true">
        <a:button
          skin="header-btn"
          right="5"
          class="panel-settings"
          submenu="mnuGitcSettings"/>
          
        <!--a:button skin="header-btn" icon="order.png" top="-22" right="7"></a:button-->
        
        <a:menu id="mnuGitcSettings">
            <a:item onclick="require('ext/gitc/tree').refresh()">Refresh Status</a:item>
            <a:divider />
        </a:menu>

        <a:vbox id="vboxDiffTreeContainer" anchors="0 0 0 0">
            <a:model id="diffModel">
                <data/>
            </a:model>

            <a:tree id="diffFiles" canrename="false" border="0" simpledata="true" model="diffModel"
              contextmenu="diffContextMenu" multiselect="true" reselectable="true"
              onbeforeremove="return require('core/util').removeInteractive(this)"
              onbeforemove="this.disable();" 
              flex="1" scrollbar="sbShared 2 2 2"
            >
                <a:each match="[project|file|folder]" sort="[@name]" sort-method="filesort">
                    <!-- <a:insert match="[folder]" get="{davProject.readdir([@path])}" /> -->
                    <a:caption match="[@name]" value="{([../@changed] == 1 ? '*' : '') + [.]}" />

                    <a:icon match="[folder[@status='added']]" value="../../../gitc/images/folder_plus_small.png" />
                    <a:icon match="[folder[@status='removed']]" value="../../../gitc/images/folder_minus_small.png" />
                    <a:icon match="[folder[@status='changed']]" value="../../../gitc/images/folder_star_small.png" />
                    <a:icon match="[folder|project]" value="folder.png" />

                    <a:selectable match="[folder|file[not(@type='fileupload')]]" />
                    <a:icon match="[file[@type='fileupload']]" value="file-tree-load-spinner.gif" />
                    <a:css match="[file[@type='fileupload']]" value="fileupload" />

                    <a:icon match="[file[@status='added']]" value="../../../gitc/images/paper_plus_small.png" />
                    <a:icon match="[file[@status='removed']]" value="../../../gitc/images/paper_minus_small.png" />
                    <a:icon match="[file[@status='changed']]" value="../../../gitc/images/paper_star_small.png" />
                    <a:icon match="[file]" value="{require('core/util').getFileIcon(%[.])}" />
                </a:each>
    
                <a:add type="folder" get="{davProject.mkdir([@path], 'New Folder')}" />
                <a:add type="file" get="{davProject.create([@path], 'New File.txt', '')}" />
                <a:rename match="[file|folder[not(@path='/workspace')]]" set="{davProject.rename([@name], [@oldpath])}" />
                <a:move set="{require('ext/gitc/tree').moveFile([@path], createPath([@path], [../@path]))}"/>
                <a:remove match="[file|folder]" set="{require('ext/filesystem/filesystem').remove([@path])}"/>
                <a:copy match="[file|folder]" set="{
                    davProject.copy([@path], createPath([@newname] || [@path], [../@path]))
                }" undo="{
                    
                }"/>
    
                <a:drag match="[folder|file]" />
                <a:drop match="[folder|file]" target="[folder]"
                    action="tree-append" copy="{event.ctrlKey}" />
                <a:drop match="[folder|file]" target="[file]"
                    action="insert-before" copy="{event.ctrlKey}" />    
            </a:tree>

            <a:model id="stageModel">
                <data/>
            </a:model>

            <a:tree id="stageFiles" canrename="false" border="0" simpledata="true" model="stageModel"
              contextmenu="stageContextMenu" multiselect="true" reselectable="true"
              onbeforeremove="return require('core/util').removeInteractive(this)"
              onbeforemove="this.disable();" 
              flex="1" scrollbar="sbShared 2 2 2"
            >
                <a:each match="[project|file|folder]" sort="[@name]" sort-method="filesort">
                    <!-- <a:insert match="[folder]" get="{davProject.readdir([@path])}" /> -->
                    <a:caption match="[@name]" value="{([../@changed] == 1 ? '*' : '') + [.]}" />
                    <a:icon match="[folder|project]" value="folder.png" />
                    <a:icon match="[folder|project]" value="../../../gitc/images/paper_minus_small.png" />
                    <a:selectable match="[folder|file[not(@type='fileupload')]]" />
                    <a:icon match="[file[@type='fileupload']]" value="file-tree-load-spinner.gif" />
                    <a:css match="[file[@type='fileupload']]" value="fileupload" />

                    <a:icon match="[file[@status='added']]" value="../../../gitc/images/paper_plus_small.png" />
                    <a:icon match="[file[@status='removed']]" value="../../../gitc/images/paper_minus_small.png" />
                    <a:icon match="[file[@status='changed']]" value="../../../gitc/images/paper_star_small.png" />
 
                    <a:icon match="[file]" value="{require('core/util').getFileIcon(%[.])}" />
                </a:each>
    
                <a:add type="folder" get="{davProject.mkdir([@path], 'New Folder')}" />
                <a:add type="file" get="{davProject.create([@path], 'New File.txt', '')}" />
                <a:rename match="[file|folder[not(@path='/workspace')]]" set="{davProject.rename([@name], [@oldpath])}" />
                <a:move set="{require('ext/gitc/tree').moveFile([@path], createPath([@path], [../@path]))}"/>
                <a:remove match="[file|folder]" set="{require('ext/filesystem/filesystem').remove([@path])}"/>
                <a:copy match="[file|folder]" set="{
                    davProject.copy([@path], createPath([@newname] || [@path], [../@path]))
                }" undo="{
                    
                }"/>
    
                <a:drag match="[folder|file]" />
                <a:drop match="[folder|file]" target="[folder]"
                    action="tree-append" copy="{event.ctrlKey}" />
                <a:drop match="[folder|file]" target="[file]"
                    action="insert-before" copy="{event.ctrlKey}" />    
            </a:tree>

            <a:text id="commit-label" value="Commit Message" class="panel-label" />
            <a:textarea id="commit-message" height="60" width="100%" class="id-commit-message" />
            <a:button id="commit-button" caption="Commit" class="id-commit-button" />
        </a:vbox>
        
        <a:menu id="diffContextMenu" disabled="{{!stServerConnected.active}}" render="runtime">
            <a:item match="[file]" onclick="require('ext/gitc/tree').stageSelectedFile()">Stage</a:item>
            <a:item match="[file]" onclick="require('ext/gitc/tree').discardSelectedFile()">Discard</a:item>
        </a:menu>
        <a:menu id="stageContextMenu" disabled="{{!stServerConnected.active}}" render="runtime">
            <a:item match="[file]" onclick="require('ext/gitc/tree').unstageSelectedFile()">Unstage</a:item>
        </a:menu>
    </a:window>
</a:application>

